<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPUè² è·ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
            opacity: 0.8;
        }

        .status {
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            backdrop-filter: blur(5px);
        }

        .status.ready {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #2c3e50;
            border-color: #3498db;
        }

        .status.running {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            color: #2d3436;
            border-color: #fdcb6e;
            animation: pulse 2s infinite;
        }

        .status.completed {
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8a3 100%);
            color: #27ae60;
            border-color: #2ecc71;
        }

        .status.error {
            background: linear-gradient(135deg, #ff7675 0%, #fd79a8 100%);
            color: #2d3436;
            border-color: #e17055;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .progress-container {
            margin: 30px 0;
            position: relative;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            width: 0%;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .progress-text {
            position: absolute;
            top: -30px;
            right: 0;
            font-size: 1rem;
            color: #333;
            font-weight: 600;
        }

        .config-display {
            background: rgba(255, 255, 255, 0.7);
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: left;
            color: #444;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .config-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .config-item {
            background: rgba(255, 255, 255, 0.5);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .config-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .config-value {
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .warning {
            background: rgba(255, 193, 7, 0.15);
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 18px;
            margin: 25px 0;
            font-size: 0.95rem;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .warning-icon {
            font-size: 1.5rem;
            color: #ffc107;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hide {
            display: none !important;
        }

        .config-info {
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: left;
            font-size: 0.9rem;
            color: #555;
        }

        .config-info-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .config-source {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.1);
            padding: 8px;
            border-radius: 5px;
            margin: 5px 0;
            word-break: break-all;
            font-size: 0.85rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            h1 {
                font-size: 2rem;
            }

            .config-grid {
                grid-template-columns: 1fr;
            }

            .metrics {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ CPUè² è·ãƒ†ã‚¹ãƒˆ</h1>
        <p class="subtitle">é«˜æ€§èƒ½è² è·ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ï¼ˆè‡ªå‹•èµ·å‹•ç‰ˆï¼‰</p>
        
        <div class="status ready" id="status">
            è¨­å®šèª­ã¿è¾¼ã¿ä¸­...
        </div>
        
        <div class="progress-container">
            <div class="progress-text" id="progressText">0%</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="metrics" id="metrics">
            <div class="metric-card">
                <div class="metric-value" id="activeThreads">0</div>
                <div class="metric-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ¬ãƒƒãƒ‰</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="elapsedTime">0</div>
                <div class="metric-label">çµŒéæ™‚é–“ (ç§’)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="cpuUsage">0%</div>
                <div class="metric-label">æ¨å®šCPUä½¿ç”¨ç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="memoryUsage">0</div>
                <div class="metric-label">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡(MB)</div>
            </div>
        </div>

        <div class="config-display">
            <div class="config-title">âš™ï¸ å®Ÿè¡Œè¨­å®š</div>
            <div class="config-grid">
                <div class="config-item">
                    <span class="config-label">å®Ÿè¡Œæ™‚é–“:</span>
                    <span class="config-value" id="configDuration">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">ã‚¹ãƒ¬ãƒƒãƒ‰æ•°:</span>
                    <span class="config-value" id="configThreads">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">è² è·å¼·åº¦:</span>
                    <span class="config-value" id="configIntensity">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">åˆ©ç”¨å¯èƒ½ã‚³ã‚¢æ•°:</span>
                    <span class="config-value" id="availableCores">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">ãƒãƒƒãƒã‚µã‚¤ã‚º:</span>
                    <span class="config-value" id="configBatchSize">-</span>
                </div>
                <div class="config-item">
                    <span class="config-label">ãƒ¡ãƒ¢ãƒªè² è·:</span>
                    <span class="config-value" id="configMemorySize">-</span>
                </div>
            </div>
        </div>

        <div class="warning">
            <span class="warning-icon">âš ï¸</span>
            <span>
                <strong>æ³¨æ„:</strong> å®Ÿè¡Œä¸­ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒé‡ããªã‚Šã¾ã™ã€‚
                ç·Šæ€¥åœæ­¢ã¯<strong>Escã‚­ãƒ¼</strong>ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚
            </span>
        </div>

        <div class="config-info">
            <div class="config-info-title">ğŸ“‹ è¨­å®šæƒ…å ±</div>
            <p><strong>è¨­å®šèª­ã¿è¾¼ã¿å…ƒ:</strong></p>
            <div class="config-source" id="configSource">èª­ã¿è¾¼ã¿ä¸­...</div>
            <p><strong>è‡ªå‹•èª­ã¿è¾¼ã¿é †åº:</strong><br>
            1. cpu_load_config.jsonï¼ˆå„ªå…ˆï¼‰<br>
            2. config.jsonï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰<br>
            3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šï¼ˆJSONèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ï¼‰</p>
        </div>

        <div class="spinner hide" id="spinner"></div>
    </div>

    <script>
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        const DEFAULT_CONFIG = {
            duration: 5,
            threads: 'auto',
            intensity: 'high',
            batchSize: 50000,
            memorySize: 100000,
            autoStart: true,
            startDelay: 1500,
            updateInterval: 100
        };

        // å¼·åº¦è¨­å®š
        const INTENSITY_CONFIGS = {
            low: { multiplier: 0.5, memoryMultiplier: 0.3 },
            medium: { multiplier: 1.0, memoryMultiplier: 0.6 },
            high: { multiplier: 1.5, memoryMultiplier: 1.0 },
            extreme: { multiplier: 2.5, memoryMultiplier: 1.5 }
        };

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let config = {};
        let workers = [];
        let isRunning = false;
        let startTime = 0;
        let completedWorkers = 0;
        let progressInterval;
        let metricsInterval;
        let memoryUsage = 0;
        let configSource = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š';

        // DOMè¦ç´ 
        const elements = {
            status: document.getElementById('status'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            spinner: document.getElementById('spinner'),
            activeThreads: document.getElementById('activeThreads'),
            elapsedTime: document.getElementById('elapsedTime'),
            cpuUsage: document.getElementById('cpuUsage'),
            memoryUsage: document.getElementById('memoryUsage'),
            configDuration: document.getElementById('configDuration'),
            configThreads: document.getElementById('configThreads'),
            configIntensity: document.getElementById('configIntensity'),
            configBatchSize: document.getElementById('configBatchSize'),
            configMemorySize: document.getElementById('configMemorySize'),
            availableCores: document.getElementById('availableCores'),
            configSource: document.getElementById('configSource')
        };

        // JSONãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•èª­ã¿è¾¼ã¿
        async function loadConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            
            config = { ...DEFAULT_CONFIG };
            
            // è‡ªå‹•ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆå„ªå…ˆé †ä½é †ï¼‰
            const configFiles = ['cpu_load_config.json', 'config.json'];
            
            for (const configFile of configFiles) {
                try {
                    const response = await fetch(configFile);
                    if (response.ok) {
                        const jsonConfig = await response.json();
                        config = { ...config, ...jsonConfig };
                        configSource = configFile;
                        console.log(`è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${configFile}`);
                        break;
                    }
                } catch (error) {
                    console.warn(`JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${configFile}`, error);
                }
            }
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆJSONã‚ˆã‚Šå„ªå…ˆï¼‰
            let urlOverrides = false;
            
            if (urlParams.get('duration')) {
                config.duration = parseInt(urlParams.get('duration')) || config.duration;
                urlOverrides = true;
            }
            
            if (urlParams.get('threads')) {
                const threadParam = urlParams.get('threads');
                config.threads = threadParam === 'auto' ? 'auto' : parseInt(threadParam) || config.threads;
                urlOverrides = true;
            }
            
            if (urlParams.get('intensity')) {
                const intensity = urlParams.get('intensity');
                config.intensity = INTENSITY_CONFIGS[intensity] ? intensity : config.intensity;
                urlOverrides = true;
            }
            
            if (urlParams.get('batchSize')) {
                config.batchSize = parseInt(urlParams.get('batchSize')) || config.batchSize;
                urlOverrides = true;
            }
            
            if (urlParams.get('memorySize')) {
                config.memorySize = parseInt(urlParams.get('memorySize')) || config.memorySize;
                urlOverrides = true;
            }

            // è¨­å®šã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            if (urlOverrides) {
                configSource += ' + URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿';
            }

            // ã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã®è‡ªå‹•èª¿æ•´
            if (config.threads === 'auto') {
                config.threads = Math.min(navigator.hardwareConcurrency || 4, 16);
            }
            
            // å¼·åº¦ã«å¿œã˜ãŸèª¿æ•´
            const intensityConfig = INTENSITY_CONFIGS[config.intensity];
            config.effectiveBatchSize = Math.floor(config.batchSize * intensityConfig.multiplier);
            config.effectiveMemorySize = Math.floor(config.memorySize * intensityConfig.memoryMultiplier);
            
            return config;
        }

        // Workerç”¨ã®ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³é–¢æ•°
        function createWorkerBlob() {
            const workerCode = `
                let isRunning = false;
                let startTime = 0;
                let config = {};
                let memoryArray = [];
                let iterationCount = 0;

                self.onmessage = function(e) {
                    if (e.data.action === 'start') {
                        isRunning = true;
                        startTime = Date.now();
                        config = e.data.config;
                        iterationCount = 0;
                        
                        // è¤‡æ•°ã®è² è·å‡¦ç†ã‚’ä¸¦è¡Œå®Ÿè¡Œ
                        intensiveCpuLoad();
                        memoryLoad();
                        
                        self.postMessage({ type: 'started' });
                    } else if (e.data.action === 'stop') {
                        isRunning = false;
                        memoryArray = [];
                        self.postMessage({ type: 'stopped' });
                    } else if (e.data.action === 'getStats') {
                        self.postMessage({ 
                            type: 'stats', 
                            memoryUsage: memoryArray.length,
                            iterations: iterationCount
                        });
                    }
                };

                function intensiveCpuLoad() {
                    function calculate() {
                        if (!isRunning) return;
                        
                        const startCalc = Date.now();
                        const calcDuration = 60; // 60msé–“è¨ˆç®—
                        
                        while (Date.now() - startCalc < calcDuration) {
                            // é›†ç´„çš„ãªæ•°å­¦è¨ˆç®—
                            for (let i = 0; i < config.effectiveBatchSize / 10; i++) {
                                // è¤‡é›‘ãªè¨ˆç®—
                                const x = Math.random() * 1000;
                                const y = Math.random() * 1000;
                                
                                Math.pow(x, y % 3);
                                Math.sin(x) * Math.cos(y);
                                Math.sqrt(x * Math.PI) + Math.log(y + 1);
                                Math.atan2(y, x);
                                
                                // é…åˆ—æ“ä½œ
                                const arr = new Array(100).fill(0).map(() => Math.random());
                                arr.sort();
                                
                                iterationCount++;
                            }
                        }
                        
                        // çµŒéæ™‚é–“ãƒã‚§ãƒƒã‚¯
                        if (Date.now() - startTime >= config.duration * 1000) {
                            self.postMessage({ type: 'completed' });
                            return;
                        }
                        
                        setTimeout(calculate, 5);
                    }
                    calculate();
                }

                function memoryLoad() {
                    const interval = setInterval(() => {
                        if (!isRunning) {
                            clearInterval(interval);
                            return;
                        }
                        
                        try {
                            // ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãƒ‘ã‚¿ãƒ¼ãƒ³
                            const chunkSize = config.effectiveMemorySize;
                            const chunk = new Array(chunkSize);
                            
                            for (let i = 0; i < chunkSize; i++) {
                                chunk[i] = {
                                    id: i,
                                    value: Math.random(),
                                    timestamp: Date.now(),
                                    data: new Array(10).fill(Math.random())
                                };
                            }
                            
                            memoryArray.push(chunk);
                            
                            // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡åˆ¶é™ï¼ˆGCå¯¾ç­–ï¼‰
                            if (memoryArray.length > 150) {
                                memoryArray.splice(0, 20);
                            }
                            
                        } catch (e) {
                            // ãƒ¡ãƒ¢ãƒªä¸è¶³æ™‚ã®å‡¦ç†
                            memoryArray = memoryArray.slice(-50);
                        }
                    }, 150);
                }
            `;
            
            return new Blob([workerCode], { type: 'application/javascript' });
        }

        // åˆæœŸåŒ–
        function initializeUI() {
            // è¨­å®šè¡¨ç¤º
            elements.configDuration.textContent = `${config.duration}ç§’`;
            elements.configThreads.textContent = config.threads;
            elements.configIntensity.textContent = config.intensity.toUpperCase();
            elements.configBatchSize.textContent = config.effectiveBatchSize.toLocaleString();
            elements.configMemorySize.textContent = config.effectiveMemorySize.toLocaleString();
            elements.availableCores.textContent = navigator.hardwareConcurrency || 'ä¸æ˜';
            elements.configSource.textContent = configSource;
            
            // åˆæœŸãƒ¡ãƒˆãƒªã‚¯ã‚¹
            elements.activeThreads.textContent = '0';
            elements.elapsedTime.textContent = '0';
            elements.cpuUsage.textContent = '0%';
            elements.memoryUsage.textContent = '0';
            
            elements.status.textContent = 'æº–å‚™å®Œäº† - è‡ªå‹•é–‹å§‹ã¾ã§å¾…æ©Ÿä¸­...';
            elements.status.className = 'status ready';
        }

        // è² è·ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startLoadTest() {
            if (isRunning) return;
            
            isRunning = true;
            startTime = Date.now();
            completedWorkers = 0;
            memoryUsage = 0;
            
            // UIæ›´æ–°
            elements.status.textContent = `ğŸ”¥ CPUè² è·ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... (${config.duration}ç§’é–“)`;
            elements.status.className = 'status running';
            elements.spinner.classList.remove('hide');
            
            // Workerä½œæˆã¨é–‹å§‹
            const workerBlob = createWorkerBlob();
            const workerUrl = URL.createObjectURL(workerBlob);
            
            for (let i = 0; i < config.threads; i++) {
                const worker = new Worker(workerUrl);
                worker.onmessage = handleWorkerMessage;
                worker.onerror = handleWorkerError;
                workers.push(worker);
                
                worker.postMessage({
                    action: 'start',
                    config: config
                });
            }
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°é–‹å§‹
            elements.activeThreads.textContent = config.threads;
            progressInterval = setInterval(updateProgress, config.updateInterval);
            metricsInterval = setInterval(updateMetrics, config.updateInterval);
            
            // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã‚‚è»½ã„è² è·
            mainThreadLoad();
        }

        // Workerãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒ³ãƒ‰ãƒ©
        function handleWorkerMessage(e) {
            if (e.data.type === 'completed') {
                completedWorkers++;
                if (completedWorkers >= config.threads) {
                    completeTest();
                }
            } else if (e.data.type === 'stats') {
                memoryUsage += e.data.memoryUsage;
            }
        }

        // Workerã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©
        function handleWorkerError(error) {
            console.error('Worker error:', error);
            elements.status.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            elements.status.className = 'status error';
            stopTest();
        }

        // é€²æ—æ›´æ–°
        function updateProgress() {
            const elapsed = Date.now() - startTime;
            const progress = Math.min((elapsed / (config.duration * 1000)) * 100, 100);
            
            elements.progressFill.style.width = progress + '%';
            elements.progressText.textContent = Math.round(progress) + '%';
            
            if (progress >= 100) {
                completeTest();
            }
        }

        // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
        function updateMetrics() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            elements.elapsedTime.textContent = elapsed;
            
            // Workerçµ±è¨ˆã‚’å–å¾—
            workers.forEach(worker => {
                worker.postMessage({ action: 'getStats' });
            });
            
            // æ“¬ä¼¼çš„ãªCPUä½¿ç”¨ç‡
            const baseUsage = 60;
            const intensityMultiplier = INTENSITY_CONFIGS[config.intensity].multiplier;
            const threadMultiplier = Math.min(config.threads / (navigator.hardwareConcurrency || 4), 1);
            const cpuUsage = Math.min(98, baseUsage + (intensityMultiplier * threadMultiplier * 30) + Math.random() * 10);
            
            elements.cpuUsage.textContent = Math.round(cpuUsage) + '%';
            
            // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡è¡¨ç¤º
            const memoryMB = Math.round(memoryUsage * config.effectiveMemorySize * 0.000001);
            elements.memoryUsage.textContent = memoryMB;
            memoryUsage = 0; // ãƒªã‚»ãƒƒãƒˆ
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰è² è·
        function mainThreadLoad() {
            let animationId;
            
            function animate() {
                if (!isRunning) return;
                
                // è»½ã„DOMæ“ä½œã¨visualåŠ¹æœ
                const hue = (Date.now() / 100) % 360;
                document.body.style.filter = `hue-rotate(${hue}deg)`;
                
                // è»½ã„è¨ˆç®—è² è·
                for (let i = 0; i < 2000; i++) {
                    Math.random() * Math.random();
                }
                
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
        }

        // ãƒ†ã‚¹ãƒˆå®Œäº†
        function completeTest() {
            if (!isRunning) return;
            
            isRunning = false;
            clearInterval(progressInterval);
            clearInterval(metricsInterval);
            
            // UIæ›´æ–°
            elements.progressFill.style.width = '100%';
            elements.progressText.textContent = '100%';
            elements.status.textContent = 'âœ… è² è·ãƒ†ã‚¹ãƒˆå®Œäº†ï¼';
            elements.status.className = 'status completed';
            elements.spinner.classList.add('hide');
            elements.activeThreads.textContent = '0';
            
            // Workerçµ‚äº†
            workers.forEach(worker => {
                worker.postMessage({ action: 'stop' });
                worker.terminate();
            });
            workers = [];
            
            // DOMæ­£å¸¸åŒ–
            document.body.style.filter = '';
            
            // 5ç§’å¾Œã«è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
            setTimeout(() => {
                location.reload();
            }, 5000);
        }

        // ç·Šæ€¥åœæ­¢
        function emergencyStop() {
            if (!isRunning) return;
            
            elements.status.textContent = 'ğŸ›‘ ç·Šæ€¥åœæ­¢ã•ã‚Œã¾ã—ãŸ';
            elements.status.className = 'status error';
            stopTest();
        }

        // ãƒ†ã‚¹ãƒˆåœæ­¢
        function stopTest() {
            isRunning = false;
            clearInterval(progressInterval);
            clearInterval(metricsInterval);
            
            workers.forEach(worker => {
                worker.postMessage({ action: 'stop' });
                worker.terminate();
            });
            workers = [];
            
            elements.spinner.classList.add('hide');
            elements.activeThreads.textContent = '0';
            document.body.style.filter = '';
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                emergencyStop();
            }
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
        window.addEventListener('load', async () => {
            elements.status.textContent = 'è¨­å®šèª­ã¿è¾¼ã¿ä¸­...';
            
            await loadConfig();
            initializeUI();
            
            // è‡ªå‹•é–‹å§‹
            setTimeout(startLoadTest, config.startDelay);
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (e) => {
            console.error('Global error:', e);
            elements.status.textContent = 'âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            elements.status.className = 'status error';
            stopTest();
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨API
        window.cpuLoadTest = {
            start: startLoadTest,
            stop: stopTest,
            config: config,
            reload: () => location.reload(),
            status: () => ({ running: isRunning, workers: workers.length })
        };
    </script>
</body>
</html>